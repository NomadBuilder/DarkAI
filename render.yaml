services:
  - type: web
    name: darkai-consolidated
    env: python
    buildCommand: |
      pip install --disable-pip-version-check --upgrade pip && pip install --disable-pip-version-check -r requirements.txt
      # Build ledger - ensure Node.js is available
      if [ -d "ledger" ]; then
        echo "=========================================="
        echo "üì¶ Building Ledger"
        echo "=========================================="
        echo "Current directory: $(pwd)"
        echo "Ledger directory exists: ‚úÖ"
        
        # Find and use Node.js
        if [ -n "$NODE_VERSION" ]; then
          NODE_DIR="/opt/render/project/nodes/node-$NODE_VERSION"
          echo "Using NODE_VERSION: $NODE_VERSION"
        else
          NODE_DIR=$(ls -d /opt/render/project/nodes/node-* 2>/dev/null | head -1)
          echo "Auto-detecting Node.js..."
        fi
        
        if [ -d "$NODE_DIR" ] && [ -f "$NODE_DIR/bin/node" ]; then
          echo "‚úÖ Found Node.js at: $NODE_DIR"
          export PATH="$NODE_DIR/bin:$PATH"
        else
          echo "‚ùå ERROR: Node.js not found at $NODE_DIR"
          echo "Please set NODE_VERSION=22.16.0 in Render dashboard"
          exit 1
        fi
        
        echo "‚úÖ Node.js: $(node --version)"
        echo "‚úÖ npm: $(npm --version)"
        echo "‚úÖ Node path: $(which node)"
        
        # Build ledger
        cd ledger || { echo "‚ùå Failed to cd into ledger"; exit 1; }
        echo ""
        echo "üìÅ In ledger directory: $(pwd)"
        echo "üìÑ Checking critical files:"
        test -f "package.json" && echo "  ‚úÖ package.json" || echo "  ‚ùå package.json missing"
        test -f "tsconfig.json" && echo "  ‚úÖ tsconfig.json" || echo "  ‚ùå tsconfig.json missing"
        test -f "next.config.js" && echo "  ‚úÖ next.config.js" || echo "  ‚ùå next.config.js missing"
        test -f "app/layout.tsx" && echo "  ‚úÖ app/layout.tsx" || echo "  ‚ùå app/layout.tsx missing"
        test -f "components/ErrorBoundary.tsx" && echo "  ‚úÖ components/ErrorBoundary.tsx" || echo "  ‚ùå components/ErrorBoundary.tsx missing"
        test -f "components/ScrollyContainer.tsx" && echo "  ‚úÖ components/ScrollyContainer.tsx" || echo "  ‚ùå components/ScrollyContainer.tsx missing"
        test -f "postcss.config.js" && echo "  ‚úÖ postcss.config.js" || echo "  ‚ùå postcss.config.js missing"
        test -f "tailwind.config.js" && echo "  ‚úÖ tailwind.config.js" || echo "  ‚ùå tailwind.config.js missing"
        
        echo ""
        echo "üìÑ Verifying postcss.config.js format:"
        cat postcss.config.js | head -5
        
        echo ""
        echo "üßπ Clearing build cache..."
        rm -rf .next out
        
        echo ""
        echo "üì¶ Running npm install..."
        npm install || { 
          echo "‚ùå npm install failed with exit code $?"
          exit 1
        }
        
        echo ""
        echo "üî® Running build..."
        echo "Environment: NODE_ENV=production, BASE_PATH=/ledger, STATIC_EXPORT=true"
        
        # Run build with environment variables inline (more reliable)
        if ! NODE_ENV=production BASE_PATH=/ledger STATIC_EXPORT=true npm run build; then
          echo ""
          echo "‚ùå Build failed with exit code $?"
          echo "Current directory: $(pwd)"
          echo "Checking for errors..."
          exit 1
        fi
        
        echo ""
        echo "‚úÖ Build command completed"
        echo "Current directory: $(pwd)"
        echo "Waiting 2 seconds for file system to sync..."
        sleep 2
        echo "Checking for out/ directory..."
        if [ -d "out" ]; then
          echo "‚úÖ out/ directory exists"
          ls -la out/ | head -10
          echo "Checking for index.html..."
          if [ -f "out/index.html" ]; then
            echo "‚úÖ out/index.html exists"
            echo "File size: $(ls -lh out/index.html | awk '{print $5}')"
          else
            echo "‚ùå out/index.html NOT found"
            echo "Contents of out/:"
            ls -la out/ | head -10
          fi
        else
          echo "‚ùå out/ directory NOT found in $(pwd)"
          echo "Current directory contents:"
          ls -la | head -15
          echo "Checking if build actually ran..."
          if [ -d ".next" ]; then
            echo "‚ö†Ô∏è  .next/ exists but out/ doesn't - static export may have failed"
            echo "Checking next.config.js output setting..."
            node -e "process.env.NODE_ENV='production'; process.env.STATIC_EXPORT='true'; const config = require('./next.config.js'); console.log('output:', config.output || 'NOT SET');"
          fi
        fi
        
        cd ..
        
        echo ""
        echo "‚úÖ Verifying build output from parent directory..."
        echo "Current directory: $(pwd)"
        if [ ! -d "ledger/out" ]; then
          echo "‚ùå ERROR: ledger/out/ directory not created"
          echo "Contents of ledger/:"
          ls -la ledger/ | head -15
          exit 1
        fi
        if [ ! -f "ledger/out/index.html" ]; then
          echo "‚ùå ERROR: ledger/out/index.html not found"
          echo "Contents of ledger/out/:"
          ls -la ledger/out/ | head -10
          exit 1
        fi
        echo "‚úÖ ledger/out/index.html exists"
        echo "‚úÖ Build artifacts:"
        ls -la ledger/out/ | head -10
        echo ""
        echo "=========================================="
        echo "‚úÖ Ledger build successful!"
        echo "=========================================="
      else
        echo "‚ùå ERROR: ledger directory not found in $(pwd)"
        echo "Directory contents:"
        ls -la | head -10
        exit 1
      fi
    startCommand: gunicorn app:app --bind 0.0.0.0:$PORT --workers 1 --threads 2 --timeout 120
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: SECRET_KEY
        generateValue: true
      - key: FLASK_ENV
        value: production
      - key: SKIP_NEO4J
        value: "0"
        comment: "Neo4j is configured in Render dashboard (NEO4J_URI, NEO4J_USERNAME, NEO4J_PASSWORD)"
      
      # Shared Database - All services use the same database
      # Using the existing blackwire database
      - key: POSTGRES_HOST
        fromDatabase:
          name: blackwire
          property: host
      - key: POSTGRES_PORT
        fromDatabase:
          name: blackwire
          property: port
      - key: POSTGRES_USER
        fromDatabase:
          name: blackwire
          property: user
      - key: POSTGRES_PASSWORD
        fromDatabase:
          name: blackwire
          property: password
      - key: POSTGRES_DB
        fromDatabase:
          name: blackwire
          property: database
      
      # All services (PersonaForge, BlackWire, ShadowStack) will use the same POSTGRES_* vars
      # They use different table names so there's no conflict
      
      # Neo4j - Set in Render dashboard (not in render.yaml for security)
      # Required: NEO4J_URI, NEO4J_USERNAME (or NEO4J_USER), NEO4J_PASSWORD
      # These are already configured in your Render environment variables
      
      # API Keys - set these manually in Render dashboard
      # PersonaForge API Keys
      - key: BUILTWITH_API_KEY
        sync: false
      - key: IPLOCATE_API_KEY
        sync: false
      - key: SHODAN_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: SERPAPI_API_KEY
        sync: false
      
      # BlackWire API Keys
      - key: IPAPI_KEY
        sync: false
      - key: VIRUSTOTAL_API_KEY
        sync: false
      - key: NUMLOOKUP_API_KEY
        sync: false
      - key: ETHERSCAN_API_KEY
        sync: false
      
      # Email Configuration (Contact Form)
      - key: RESEND_API_KEY
        sync: false
      - key: FROM_EMAIL
        value: onboarding@resend.dev
      - key: CONTACT_EMAIL
        value: aazirmun@gmail.com

databases:
  # Using existing blackwire database (shared by all services)
  # The blackwire database already exists in Render
  - name: blackwire
    databaseName: blackwire
    user: blackwire_user
    plan: free

