services:
  - type: web
    name: darkai-consolidated
    env: python
    buildCommand: |
      pip install --disable-pip-version-check --upgrade pip && pip install --disable-pip-version-check -r requirements.txt
      # Build ledger - ensure Node.js is available
      if [ -d "ledger" ]; then
        echo "üì¶ Building ledger..."
        echo "NODE_VERSION env var: ${NODE_VERSION:-not set}"
        
        # Use NODE_VERSION if set, otherwise try to find Node.js automatically
        if [ -n "$NODE_VERSION" ]; then
          echo "üì• Using Node.js version from NODE_VERSION: $NODE_VERSION"
          # Check for Node.js in standard Render location with specific version
          NODE_DIR="/opt/render/project/nodes/node-$NODE_VERSION"
          if [ -d "$NODE_DIR" ] && [ -f "$NODE_DIR/bin/node" ]; then
            echo "‚úÖ Found Node.js at: $NODE_DIR"
            export PATH="$NODE_DIR/bin:$PATH"
          else
            echo "‚ö†Ô∏è  Node.js $NODE_VERSION not found at $NODE_DIR, trying auto-detect..."
            # Fall back to auto-detection
            if [ -d "/opt/render/project/nodes" ]; then
              NODE_DIR=$(ls -d /opt/render/project/nodes/node-* 2>/dev/null | head -1)
              if [ -n "$NODE_DIR" ] && [ -f "$NODE_DIR/bin/node" ]; then
                echo "üì• Found Node.js at: $NODE_DIR"
                export PATH="$NODE_DIR/bin:$PATH"
              fi
            fi
          fi
        else
          echo "üì• Auto-detecting Node.js..."
          # Check for Node.js in standard Render location
          if [ -d "/opt/render/project/nodes" ]; then
            NODE_DIR=$(ls -d /opt/render/project/nodes/node-* 2>/dev/null | head -1)
            if [ -n "$NODE_DIR" ] && [ -f "$NODE_DIR/bin/node" ]; then
              echo "üì• Found Node.js at: $NODE_DIR"
              export PATH="$NODE_DIR/bin:$PATH"
            fi
          fi
        fi
        
        # Verify Node.js is available
        if ! command -v node &> /dev/null; then
          echo "‚ùå ERROR: Node.js not found"
          echo "Please ensure NODE_VERSION is set in Render dashboard (e.g., 22.16.0)"
          exit 1
        fi
        echo "‚úÖ Node.js version: $(node --version 2>&1)"
        echo "‚úÖ npm version: $(npm --version 2>&1)"
        echo "‚úÖ Node.js path: $(which node)"
        
        cd ledger || { echo "‚ùå Failed to cd into ledger directory"; exit 1; }
        echo "üì¶ Running npm install..."
        npm install || { echo "‚ùå npm install failed"; exit 1; }
        echo "üì¶ Running npm run build..."
        BASE_PATH=/ledger STATIC_EXPORT=true npm run build || { echo "‚ùå npm run build failed"; exit 1; }
        cd ..
        if [ -d "ledger/out" ]; then
          echo "‚úÖ Ledger build successful - ledger/out/ exists"
          echo "Contents of ledger/out/:"
          ls -la ledger/out/ | head -10
          if [ -f "ledger/out/index.html" ]; then
            echo "‚úÖ index.html exists"
          else
            echo "‚ùå WARNING: index.html not found in ledger/out/"
          fi
        else
          echo "‚ùå ERROR: ledger/out/ directory not created after build"
          echo "Current directory contents:"
          ls -la ledger/ | head -10
          exit 1
        fi
      else
        echo "‚ùå ERROR: ledger directory not found"
        echo "Current directory: $(pwd)"
        echo "Directory contents:"
        ls -la | head -10
        exit 1
      fi
    startCommand: gunicorn app:app --bind 0.0.0.0:$PORT --workers 1 --threads 2 --timeout 120
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: SECRET_KEY
        generateValue: true
      - key: FLASK_ENV
        value: production
      - key: SKIP_NEO4J
        value: "0"
        comment: "Neo4j is configured in Render dashboard (NEO4J_URI, NEO4J_USERNAME, NEO4J_PASSWORD)"
      
      # Shared Database - All services use the same database
      # Using the existing blackwire database
      - key: POSTGRES_HOST
        fromDatabase:
          name: blackwire
          property: host
      - key: POSTGRES_PORT
        fromDatabase:
          name: blackwire
          property: port
      - key: POSTGRES_USER
        fromDatabase:
          name: blackwire
          property: user
      - key: POSTGRES_PASSWORD
        fromDatabase:
          name: blackwire
          property: password
      - key: POSTGRES_DB
        fromDatabase:
          name: blackwire
          property: database
      
      # All services (PersonaForge, BlackWire, ShadowStack) will use the same POSTGRES_* vars
      # They use different table names so there's no conflict
      
      # Neo4j - Set in Render dashboard (not in render.yaml for security)
      # Required: NEO4J_URI, NEO4J_USERNAME (or NEO4J_USER), NEO4J_PASSWORD
      # These are already configured in your Render environment variables
      
      # API Keys - set these manually in Render dashboard
      # PersonaForge API Keys
      - key: BUILTWITH_API_KEY
        sync: false
      - key: IPLOCATE_API_KEY
        sync: false
      - key: SHODAN_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: SERPAPI_API_KEY
        sync: false
      
      # BlackWire API Keys
      - key: IPAPI_KEY
        sync: false
      - key: VIRUSTOTAL_API_KEY
        sync: false
      - key: NUMLOOKUP_API_KEY
        sync: false
      - key: ETHERSCAN_API_KEY
        sync: false
      
      # Email Configuration (Contact Form)
      - key: RESEND_API_KEY
        sync: false
      - key: FROM_EMAIL
        value: onboarding@resend.dev
      - key: CONTACT_EMAIL
        value: aazirmun@gmail.com

databases:
  # Using existing blackwire database (shared by all services)
  # The blackwire database already exists in Render
  - name: blackwire
    databaseName: blackwire
    user: blackwire_user
    plan: free

