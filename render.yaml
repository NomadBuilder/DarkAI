services:
  - type: web
    name: darkai-consolidated
    env: python
    buildCommand: |
      pip install --disable-pip-version-check --upgrade pip && pip install --disable-pip-version-check -r requirements.txt
      # Build ledger - ensure Node.js is available
      if [ -d "ledger" ]; then
        echo "üì¶ Building ledger..."
        # Check if Node.js is available, try nvm if not
        if ! command -v node &> /dev/null; then
          echo "üì• Node.js not found, trying nvm..."
          export NVM_DIR="$HOME/.nvm"
          [ -s "$NVM_DIR/nvm.sh" ] && \. "$NVM_DIR/nvm.sh" || true
          if command -v nvm &> /dev/null; then
            nvm install 20
            nvm use 20
          elif [ -s "/opt/render/.nvm/nvm.sh" ]; then
            source /opt/render/.nvm/nvm.sh
            nvm install 20
            nvm use 20
          else
            echo "‚ùå ERROR: Node.js not available and nvm not found"
            echo "Please ensure Node.js is available in the build environment"
            exit 1
          fi
        fi
        echo "‚úÖ Node.js version: $(node --version 2>&1 || echo 'not found')"
        echo "‚úÖ npm version: $(npm --version 2>&1 || echo 'not found')"
        cd ledger
        npm install || { echo "‚ùå npm install failed"; exit 1; }
        BASE_PATH=/ledger STATIC_EXPORT=true npm run build || { echo "‚ùå npm run build failed"; exit 1; }
        cd ..
        if [ -d "ledger/out" ]; then
          echo "‚úÖ Ledger build successful - ledger/out/ exists"
          ls -la ledger/out/ | head -5
        else
          echo "‚ùå ERROR: ledger/out/ directory not created after build"
          exit 1
        fi
      else
        echo "‚ùå ERROR: ledger directory not found"
        exit 1
      fi
    startCommand: gunicorn app:app --bind 0.0.0.0:$PORT --workers 1 --threads 2 --timeout 120
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: SECRET_KEY
        generateValue: true
      - key: FLASK_ENV
        value: production
      - key: SKIP_NEO4J
        value: "0"
        comment: "Neo4j is configured in Render dashboard (NEO4J_URI, NEO4J_USERNAME, NEO4J_PASSWORD)"
      
      # Shared Database - All services use the same database
      # Using the existing blackwire database
      - key: POSTGRES_HOST
        fromDatabase:
          name: blackwire
          property: host
      - key: POSTGRES_PORT
        fromDatabase:
          name: blackwire
          property: port
      - key: POSTGRES_USER
        fromDatabase:
          name: blackwire
          property: user
      - key: POSTGRES_PASSWORD
        fromDatabase:
          name: blackwire
          property: password
      - key: POSTGRES_DB
        fromDatabase:
          name: blackwire
          property: database
      
      # All services (PersonaForge, BlackWire, ShadowStack) will use the same POSTGRES_* vars
      # They use different table names so there's no conflict
      
      # Neo4j - Set in Render dashboard (not in render.yaml for security)
      # Required: NEO4J_URI, NEO4J_USERNAME (or NEO4J_USER), NEO4J_PASSWORD
      # These are already configured in your Render environment variables
      
      # API Keys - set these manually in Render dashboard
      # PersonaForge API Keys
      - key: BUILTWITH_API_KEY
        sync: false
      - key: IPLOCATE_API_KEY
        sync: false
      - key: SHODAN_API_KEY
        sync: false
      - key: OPENAI_API_KEY
        sync: false
      - key: SERPAPI_API_KEY
        sync: false
      
      # BlackWire API Keys
      - key: IPAPI_KEY
        sync: false
      - key: VIRUSTOTAL_API_KEY
        sync: false
      - key: NUMLOOKUP_API_KEY
        sync: false
      - key: ETHERSCAN_API_KEY
        sync: false
      
      # Email Configuration (Contact Form)
      - key: RESEND_API_KEY
        sync: false
      - key: FROM_EMAIL
        value: onboarding@resend.dev
      - key: CONTACT_EMAIL
        value: aazirmun@gmail.com

databases:
  # Using existing blackwire database (shared by all services)
  # The blackwire database already exists in Render
  - name: blackwire
    databaseName: blackwire
    user: blackwire_user
    plan: free

